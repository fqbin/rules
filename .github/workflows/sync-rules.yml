name: Sync Rules

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download Surge rule lists
        run: |
          mkdir -p rules
          cd rules
          echo "Downloading .list rule files..."

          URLS=(
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Netflix/Netflix.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Disney/Disney.list"
            "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/GlobalMedia/GlobalMedia_All_No_Resolve.list"
            "https://raw.githubusercontent.com/EAlyce/conf/refs/heads/main/Rule/OpenAI.list"
          )

          for u in "${URLS[@]}"; do
            echo "Download $u"
            curl -fsS -O "$u"
          done

      - name: Convert to Sing-Box rule-set JSON (legacy)
        run: |
          mkdir -p singbox_rules

          for file in rules/*.list; do
            name=$(basename "$file" .list)
            out="singbox_rules/${name}.json"

            echo "Processing $file -> $out"

            DOMAIN=""
            DOMAIN_SUFFIX=""
            DOMAIN_KEYWORD=""
            IP_CIDR=""

            while IFS= read -r line; do
              # Remove comments and empty lines
              [[ "$line" =~ ^# ]] && continue
              [[ -z "$line" ]] && continue

              IFS=',' read -r type value _ <<< "$line"

              case "$type" in
                DOMAIN)
                  DOMAIN="$DOMAIN\"$value\","
                  ;;
                DOMAIN-SUFFIX)
                  DOMAIN_SUFFIX="$DOMAIN_SUFFIX\"$value\","
                  ;;
                DOMAIN-KEYWORD)
                  DOMAIN_KEYWORD="$DOMAIN_KEYWORD\"$value\","
                  ;;
                IP-CIDR|IP-CIDR6)
                  IP_CIDR="$IP_CIDR\"$value\","
                  ;;
              esac
            done < "$file"

            # Start JSON
            echo '{' > "$out"
            echo '  "rules": [' >> "$out"

            SEP=""

            if [[ -n "$DOMAIN" ]]; then
              echo "    { \"domain\": [${DOMAIN%,}] }" >> "$out"
              SEP=","
            fi

            if [[ -n "$DOMAIN_SUFFIX" ]]; then
              [[ -n "$SEP" ]] && echo "    $SEP" >> "$out"
              echo "    { \"domain_suffix\": [${DOMAIN_SUFFIX%,}] }" >> "$out"
              SEP=","
            fi

            if [[ -n "$DOMAIN_KEYWORD" ]]; then
              [[ -n "$SEP" ]] && echo "    $SEP" >> "$out"
              echo "    { \"domain_keyword\": [${DOMAIN_KEYWORD%,}] }" >> "$out"
              SEP=","
            fi

            if [[ -n "$IP_CIDR" ]]; then
              [[ -n "$SEP" ]] && echo "    $SEP" >> "$out"
              echo "    { \"ip_cidr\": [${IP_CIDR%,}] }" >> "$out"
            fi

            echo '  ]' >> "$out"
            echo '}' >> "$out"
          done

      - name: Commit changes
        run: |
          git add .
          git commit -m "Auto update sing-box rules $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git push
